<app-settings-sidebar></app-settings-sidebar>
<chef-loading-spinner *ngIf="loading$ | async" size='50' fixed></chef-loading-spinner>

<div class="container token-container">
  <main>
    <chef-page-header contrastingBackground>
      <chef-heading>API Tokens</chef-heading>
      <chef-subheading>API tokens grant authorized access to the Chef Automate API.</chef-subheading>
    </chef-page-header>

    <app-create-object-modal [visible]="createModalVisible" [creating]="creatingToken"
      [conflictErrorEvent]="conflictErrorEvent" objectNoun="token" [createForm]="createTokenForm"
      [showProjectsDropdown]="projectsEnabled$ | async" [assignableProjects]="dropdownProjects"
      (close)="closeCreateModal()" (createClicked)="createToken()">
    </app-create-object-modal>

    <app-delete-object-modal [visible]="deleteModalVisible" objectNoun="token" [objectName]="tokenToDelete?.name"
      (close)="closeDeleteModal()" (deleteClicked)="deleteToken()" objectAction="Delete">
    </app-delete-object-modal>

    <div class="page-body">
      <chef-toolbar>
        <app-authorized [anyOf]="[['/iam/v2beta/tokens', 'post'], ['/auth/tokens', 'post']]">
          <div *ngIf="(apiTokenCount$ | async) === 0" class="empty-state">
            <p>Create the first token to get started!</p>
          </div>
          <div [ngClass]="(apiTokenCount$ | async) === 0 ? 'empty-state' : ''">
            <chef-button id="create-button" primary (click)="openCreateModal()">Create Token</chef-button>
          </div>
        </app-authorized>
      </chef-toolbar>
      <app-authorized [anyOf]="[['/iam/v2beta/tokens', 'get'], ['/auth/tokens', 'get']]">
        <table class="tably" style="width:100%" *ngIf="(apiTokenCount$ | async) > 0">
          <tr *ngFor="let token of sortedApiTokens$ | async">
            <td>
              <a [routerLink]="['/settings/tokens', token.id]">{{ token.name }}</a>
            </td>
            <td *ngIf="(iamMajorVersion$ | async) !== 'v1'">{{ token.id }}</td>
            <td *ngIf="projectsEnabled$ | async" class="projects-column">
              <span *ngIf="token.projects.length === 0">{{ unassigned }}</span>
              <span *ngIf="token.projects.length === 1">{{ token.projects[0] }}</span>
              <span *ngIf="token.projects.length > 1">{{ token.projects.length }} projects</span>
            </td>
            <td>{{ token.created_at | datetime: RFC2822 }}</td>
            <td>
              <ng-container *ngIf="token.active">Active</ng-container>
              <ng-container *ngIf="!token.active">Inactive</ng-container>
            </td>
            <td class="controls">
              <ul id="menu-{{token.id}}">
                <li (click)="notifyCopy()">
                  <chef-clipboard plain value={{token.value}} label="Copy Token" icon=""></chef-clipboard>
                </li>
                <li (click)="toggleActive(token)">Toggle Status</li>
                <li (click)="startTokenDelete(token)">Delete Token</li>
              </ul>
            </td>
          </tr>
        </table>
      </app-authorized>
    </div>
  </main>
</div>
